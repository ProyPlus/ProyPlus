<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-card header="Usuarios">
  <div class="p-d-flex p-jc-between p-ai-center p-mb-3" style="margin-bottom:1rem">
    <div>
      <input pInputText type="text" placeholder="Buscar…" (input)="dt.filterGlobal($any($event.target).value, 'contains')">
    </div>
    <button pButton type="button" label="Nuevo usuario" icon="pi pi-user-plus" class="p-button-success"
            (click)="openNew()"></button>
  </div>

  <p-table #dt [value]="users" [loading]="loading" dataKey="id" [paginator]="true" [rows]="10" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="username">Usuario <p-sortIcon field="username" /></th>
        <th>Email</th>
        <th>Roles</th>
        <th>Estado</th>
        <th style="width: 140px;">Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-row>
      <tr>
        <td>{{ row.username }}</td>
        <td>{{ row.email }}</td>
        <td>
          <p-tag *ngFor="let r of row.rolesList" [value]="r.role" class="mr-1"></p-tag>
        </td>
        <td>
          <p-tag [value]="row.enabled ? 'Habilitado' : 'Deshabilitado'" [severity]="row.enabled ? 'success' : 'danger'"></p-tag>
        </td>
        <td>
          <button pButton icon="pi pi-pencil" class="p-button-text p-button-sm" (click)="edit(row)"></button>
          <button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-sm" (click)="del(row)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<!-- Dialog Crear/Editar -->
<p-dialog
  [(visible)]="showDialog"
  [modal]="true"
  [style]="{ width: '720px', maxWidth: '95vw' }"
  [contentStyle]="{ 'max-height': '75vh', 'overflow': 'auto' }"
  [header]="isEdit ? 'Editar usuario' : 'Nuevo usuario'"
  (onHide)="onDialogHide()"
>
  <form #userForm="ngForm" class="p-fluid p-formgrid p-grid" style="row-gap:1rem" novalidate>
    <!-- Usuario -->
    <div class="p-field p-col-12 p-md-6">
      <label for="username">Usuario <span style="color:red">*</span></label>
      <input
        id="username"
        pInputText
        [(ngModel)]="formModel.username"
        name="username"
        required
        #username="ngModel"
        [ngClass]="{ 'p-invalid': username.invalid && username.touched }"
      />
      <small class="p-error" *ngIf="username.invalid && username.touched">
        Usuario es obligatorio
      </small>
    </div>

    <!-- Email -->
    <div class="p-field p-col-12 p-md-6">
      <label for="email">Email <span style="color:red">*</span></label>
      <input
        id="email"
        pInputText
        type="email"
        [(ngModel)]="formModel.email"
        name="email"
        required
        email
        #email="ngModel"
        [ngClass]="{ 'p-invalid': email.invalid && email.touched }"
      />
      <small class="p-error" *ngIf="email.invalid && email.touched">
        Ingrese un email válido
      </small>
    </div>
    
    <!-- Password -->
    <div class="p-field p-col-12 p-md-4">
      <label for="password">Password</label>
      <input
        id="password"
        pPassword
        [(ngModel)]="formModel.password"
        name="password"
        toggleMask="true"
        [feedback]="false"
      />
    </div>
    <!-- Roles -->
    <div class="p-field p-col-12">
      <label>Roles</label>
      <p-multiSelect
        [options]="availableRoles"
        [(ngModel)]="selectedRoles"
        optionLabel="role"
        display="chip"
        name="roles"
        class="w-100"
      >
      </p-multiSelect>
    </div>

    <!-- Checks -->
    <div class="p-formgrid p-grid p-col-12">
      <div class="p-field-checkbox p-col-12 p-md-6" *ngFor="let chk of [
        {key: 'enabled', label: 'Habilitado'},
        {key: 'mustChangePassword', label: 'Debe cambiar pass'},
        {key: 'accountNotExpired', label: 'Cuenta no expirada'},
        {key: 'accountNotLocked', label: 'Cuenta no bloqueada'},
        {key: 'credentialNotExpired', label: 'Credencial no expirada'}
      ]">
        <p-checkbox [(ngModel)]="formModel[chk.key]" [name]="chk.key" binary="true"></p-checkbox>
        <label class="ml-2">{{ chk.label }}</label>
      </div>
    </div>

    <!-- Footer -->
    <div class="p-d-flex p-jc-end p-gap-2 p-mt-3 p-col-12">
      <button pButton type="button" label="Cancelar" class="p-button-text" (click)="showDialog=false"></button>
      <button
        pButton
        type="button"
        label="Guardar"
        icon="pi pi-check"
        class="p-button-success"
        [disabled]="userForm.invalid"
        (click)="save(userForm)"
      ></button>
    </div>
  </form>
</p-dialog>
